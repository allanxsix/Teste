_ENV = (getgenv or getrenv or getfenv)()

if not game:IsLoaded() then
    game.Loaded:Wait()
end
local Players = game:GetService("Players")
local ReplicatedStorage = game:GetService("ReplicatedStorage")
local TweenService = game:GetService("TweenService")
local RunService = game:GetService("RunService")
local UserInputService = game:GetService("UserInputService")
local CoreGui = game:GetService("CoreGui")
local HttpService = game:GetService("HttpService")
local Player = Players.LocalPlayer
local lastNotificationTime = 0
local notificationCooldown = 10
local currentTime = tick()
if currentTime - lastNotificationTime >= notificationCooldown then
    game.StarterGui:SetCore("SendNotification", {
        Title = "Allan hub",
        Text = "Loading",
        Duration = 5
    })
    lastNotificationTime = currentTime
end

local BridgeNet2 = require(ReplicatedStorage:WaitForChild("BridgeNet2"))
local DungeonBridge = BridgeNet2.ReferenceBridge("GENERAL_EVENT")

local function SafeFire(payload)
    if not DungeonBridge then return end
    local ok, err = pcall(function()
        DungeonBridge:Fire(payload)
    end)
    if not ok then
        warn("SafeFire error:", err, payload)
    end
end

local Fluent = loadstring(game:HttpGet("https://github.com/dawid-scripts/Fluent/releases/latest/download/main.lua"))()

local SaveManager = loadstring(game:HttpGet(
    "https://raw.githubusercontent.com/dawid-scripts/Fluent/master/Addons/SaveManager.lua"
))()

local Window = Fluent:CreateWindow({
    Title = "Allan Hub",
    SubTitle = "Dungeon + Castle + Runes (FIX)",
    TabWidth = 160,
    Size = UDim2.fromOffset(560, 440),
    Acrylic = true,
    Theme = "dark",
    MinimizeKey = Enum.KeyCode.LeftControl
})

SaveManager:SetLibrary(Fluent)
SaveManager:SetFolder("AllanHub")

local Tabs = {
    Dungeon = Window:AddTab({ Title = "Tab Dungeon", Icon = "swords" }),
    Castle  = Window:AddTab({ Title = "Tab Castelo Infernal", Icon = "flame" }),
    Islands = Window:AddTab({ Title = "Tab Islands", Icon = "map" }),
    Settings= Window:AddTab({ Title = "Tab Settings", Icon = "settings" })
}
local Players = game:GetService("Players")
local ContentProvider = game:GetService("ContentProvider")
local playerGui = Players.LocalPlayer:WaitForChild("PlayerGui")
local existingGui = playerGui:FindFirstChild("CustomScreenGui")
if existingGui then
    existingGui:Destroy()
end
local ScreenGui = Instance.new("ScreenGui")
ScreenGui.Name = "CustomScreenGui"
ScreenGui.Parent = playerGui
local Button = Instance.new("ImageButton")
Button.Name = "CustomButton"
Button.Parent = ScreenGui
Button.Size = UDim2.new(0, 50, 0, 50)
Button.Position = UDim2.new(0.015, 0, 0.02, 20)
Button.BackgroundTransparency = 1
Button.Image = "rbxassetid://112254107346248"
local UICorner = Instance.new("UICorner")
UICorner.CornerRadius = UDim.new(1, 0)
UICorner.Parent = Button
local imageLoaded = false
ContentProvider:PreloadAsync({Button.Image}, function()
    imageLoaded = true
end)
Button.MouseButton1Click:Connect(function()
    if not imageLoaded then
        return
    end
    local VirtualInputManager = game:GetService("VirtualInputManager")
    if VirtualInputManager then
        task.defer(function()
            VirtualInputManager:SendKeyEvent(true, Enum.KeyCode.LeftControl, false, game)
            VirtualInputManager:SendKeyEvent(false, Enum.KeyCode.LeftControl, false, game)
        end)
    end
end)


-- =====================================================
-- STATUS
-- =====================================================
local Status = Tabs.Dungeon:AddParagraph({
    Title = "Status",
    Content = "Idle"
})

-- =====================================================
-- CONFIG (GLOBAL â€“ NÃƒO DUPLICAR)
-- =====================================================
Config = {
    -- Dungeon
    AutoFarm = false,
    AutoBuyTicket = false,
    MoveMode = "Tween",
    UseRunesAuto = false,

    -- Rebirth
    AutoRebirth = false,

    -- Castle
    CastleInf = false,
    AutoCastle = false,
    CastleCreateOnly = false,
    CastleSpeed = "1",
    CastleSpeedEnabled = false,
    EntryFloor = 1,
    ResetFloor = 100
}

-- =====================================================
-- FLAGS / STATES GERAIS
-- =====================================================
local CreatingDungeon = false
local DungeonRunning = false
local StartingDungeon = false
local Rebirthing = false
local SpawnConfirmTime = 0
local currentTween = nil

-- =====================================================
-- UI DUNGEON (BASE)
-- =====================================================
Tabs.Dungeon:AddToggle("AutoFarmDungeon", {
    Title = "Auto Farm Dungeon",
    Default = false,
    Flag = "AutoFarmDungeon",
    Callback = function(v)
        Config.AutoFarm = v
    end
})

Tabs.Dungeon:AddToggle("AutoBuyTicket", {
    Title = "Auto Buy Ticket",
    Default = false,
    Flag = "AutoBuyTicket",
    Callback = function(v)
        Config.AutoBuyTicket = v
    end
})

Tabs.Dungeon:AddDropdown("MoveMode", {
    Title = "Movement Mode",
    Values = { "Tween", "Teleport" },
    Default = "Tween",
    Flag = "MoveMode",
    Callback = function(v)
        Config.MoveMode = v
    end
})

Tabs.Dungeon:AddToggle("AutoRebirth", {
    Title = "Auto Rebirth (MAX)",
    Description = "Faz rebirth automaticamente ao atingir level mÃ¡ximo",
    Default = false,
    Flag = "AutoRebirth",
    Callback = function(v)
        Config.AutoRebirth = v
    end
})

-- =====================================================
-- SETTINGS
-- =====================================================
SaveManager:BuildConfigSection(Tabs.Settings)

-- =====================================================
-- NOTIFY INICIAL
-- =====================================================
Fluent:Notify({
    Title = "Allan Hub",
    Content = "Parte 1 carregada com sucesso",
    Duration = 5
})
-- =====================================================
-- DUNGEON â€” ENEMIES (FIX: SEM .Position)
-- =====================================================
local EnemiesFolder = workspace.__Main.__Enemies.Server

local function GetClosestEnemy()
local char = Player.Character
local root = char and char:FindFirstChild("HumanoidRootPart")
if not root then return nil end

local pos = root.Position  
local best, dist = nil, math.huge  

for _, e in ipairs(EnemiesFolder:GetChildren()) do  
    local hp = e:GetAttribute("HP")  
    if hp and hp > 0 and e.Position then  
        local d = (pos - e.Position).Magnitude  
        if d < dist then  
            dist = d  
            best = e  
        end  
    end  
end  

return best

end

local function MoveToEnemy(enemy)
local root = Player.Character.HumanoidRootPart
if not root then return end

if Config.MoveMode == "Teleport" then  
    if currentTween then currentTween:Cancel() end  
    root.CFrame = enemy.CFrame  
else  
    if currentTween then currentTween:Cancel() end  
    currentTween = TweenService:Create(  
        root,  
        TweenInfo.new(0.3),  
        { CFrame = enemy.CFrame }  
    )  
    currentTween:Play()  
end

end

-- =====================================================
-- RUNAS (5 SLOTS)
-- =====================================================
local MAX_RUNE_SLOTS = 5
local RuneSlots = {}
for i = 1, MAX_RUNE_SLOTS do RuneSlots[i] = "" end

local ItemsInfo
pcall(function()
    ItemsInfo = require(
        ReplicatedStorage:WaitForChild("Indexer"):WaitForChild("ItemsInfo")
    )
end)

local AvailableRunes = {}

local function ScanRunes()
    table.clear(AvailableRunes)
    if not ItemsInfo then return end

    for id, data in pairs(ItemsInfo) do
        if typeof(data) == "table" then
            local t = tostring(data.Type or "")
            local n = tostring(data.Name or "")
            if string.find(string.lower(t), "rune") or
               string.find(string.lower(n), "rune") then
                table.insert(AvailableRunes, {
                    Id = id,
                    Name = data.Name or tostring(id)
                })
            end
        end
    end
end

ScanRunes()

local RuneNames = { "Nenhuma" }
for _, r in ipairs(AvailableRunes) do
    table.insert(RuneNames, r.Name)
end

Tabs.Dungeon:AddParagraph({
    Title = "ðŸ”® Runas",
    Content = "Selecione atÃ© 5 runas para a dungeon"
})

for slot = 1, MAX_RUNE_SLOTS do
    Tabs.Dungeon:AddDropdown("RuneSlot" .. slot, {
        Title = "Runa Slot " .. slot,
        Values = RuneNames,
        Default = "Nenhuma",
        Flag = "RuneSlot" .. slot,
        Callback = function(v)
            if v == "Nenhuma" then
                RuneSlots[slot] = ""
            else
                for _, r in ipairs(AvailableRunes) do
                    if r.Name == v then
                        RuneSlots[slot] = r.Id
                        break
                    end
                end
            end
        end
    })
end

Tabs.Dungeon:AddToggle("UseRunesAuto", {
    Title = "Usar Runas Automaticamente",
    Default = false,
    Flag = "UseRunesAuto",
    Callback = function(v)
        Config.UseRunesAuto = v
    end
})

-- =====================================================
-- DUNGEON ACTIONS
-- =====================================================
local function BuyDungeonTicket()
    SafeFire({
        Event = "DungeonAction",
        Action = "BuyTicket"
    })
end

local function ApplyRunes()
    for slot = 1, MAX_RUNE_SLOTS do
        local runeId = RuneSlots[slot]
        if runeId ~= "" then
            SafeFire({
                Event = "DungeonAction",
                Action = "AddItem",
                Slot = slot,
                Item = runeId
            })
            task.wait(0.15)
        end
    end
end

local function CreateDungeon()
    if CreatingDungeon or Rebirthing then return end

    CreatingDungeon = true
    StartingDungeon = true
    Status:SetDesc("Creating Dungeon")

    if Config.AutoBuyTicket then
        BuyDungeonTicket()
        task.wait(0.8)
    end

    SafeFire({
        Event = "DungeonAction",
        Action = "Create"
    })

    task.wait(0.6)

    if Config.UseRunesAuto then
        ApplyRunes()
        task.wait(0.3)
    end

    SafeFire({
        Event = "DungeonAction",
        Action = "Start"
    })

    task.delay(2, function()
        CreatingDungeon = false
    end)
end

-- =====================================================
-- AUTO DUNGEON LOOP (FIXADO)
-- =====================================================
RunService.Heartbeat:Connect(function(dt)
    if not Config.AutoFarm or Rebirthing then
        DungeonRunning = false
        SpawnConfirmTime = 0
        Status:SetDesc("Idle")
        return
    end

    local enemy = GetClosestEnemy()

    if enemy then
        DungeonRunning = true
        StartingDungeon = false
        SpawnConfirmTime = 0
        Status:SetDesc("Farming (" .. Config.MoveMode .. ")")
        MoveToEnemy(enemy)
        AttackEnemy(enemy)
        return
    end

    if DungeonRunning then
        SpawnConfirmTime += dt
        Status:SetDesc(("Finalizando Dungeon %.1fs"):format(SpawnConfirmTime))
        if SpawnConfirmTime >= 1.8 then
            DungeonRunning = false
            SpawnConfirmTime = 0
            CreateDungeon()
        end
    else
        CreateDungeon()
    end
end)

Fluent:Notify({
    Title = "Dungeon",
    Content = "Parte 2 carregada (Ataque + Runas OK)",
    Duration = 5
})
-- =====================================================
-- CASTLE â€” VARIÃVEIS DE CONTROLE
-- =====================================================
local castleInfEnabled = false
local autoCastleEnabled = false
local castleCreateOnlyEnabled = false
local castleSessionActive = false

local entryFloor = Config.EntryFloor or 1
local resetFloor = Config.ResetFloor or 100
local selectedCastleSpeed = Config.CastleSpeed or "1"
local castleSpeedEnabled = Config.CastleSpeedEnabled or false

-- =====================================================
-- CASTLE â€” FUNÃ‡Ã•ES BASE
-- =====================================================
local function getCurrentCastleFloor()
    local main = workspace:FindFirstChild("__Main")
    if not main then return nil end
    local world = main:FindFirstChild("__World")
    if not world then return nil end

    local current = nil
    for i = 1, 300 do
        if world:FindFirstChild("Room_" .. i) then
            current = i
        end
    end
    return current
end

local function buyCastleTicket()
    SafeFire({
        Event = "CastleAction",
        Action = "BuyTicket",
        Type = "Gems"
    })
end

local function createCastle()
    SafeFire({
        Event = "CastleAction",
        Action = "Create"
    })
    task.wait(2.5)
end

local function joinCastle(floor)
    SafeFire({
        Event = "CastleAction",
        Action = "Join",
        Floor = tostring(floor or entryFloor),
        Check = true
    })
end

-- =====================================================
-- CASTLE â€” PORTAL
-- =====================================================
local function findFirePortal()
    local main = workspace:FindFirstChild("__Main")
    if not main then return nil end
    local world = main:FindFirstChild("__World")
    if not world then return nil end

    for i = 1, 300 do
        local room = world:FindFirstChild("Room_" .. i)
        if room then
            local portal = room:FindFirstChild("FirePortal", true)
            if portal then
                return portal, i
            end
        end
    end
    return nil
end

local function teleportToFirePortal()
    local portal = findFirePortal()
    if not portal then return false end

    local char = Player.Character
    local hrp = char and char:FindFirstChild("HumanoidRootPart")
    if not hrp then return false end

    hrp.CFrame = portal:GetPivot() * CFrame.new(0, 2, -3)
    hrp.Velocity = Vector3.zero
    return true
end

local function activateFirePortal()
    local portal = findFirePortal()
    if not portal then return false end

    local prompt = portal:FindFirstChildWhichIsA("ProximityPrompt", true)
    if not prompt then return false end

    for _ = 1, 3 do
        pcall(function()
            fireproximityprompt(prompt)
        end)
        task.wait(0.15)
    end
    return true
end

-- =====================================================
-- CASTLE â€” FARM MOBS (FIX POSITION)
-- =====================================================
-- Farm mobs no castle
local function farmCastleMobs()
    local mobsKilled = false
    local enemiesFolder = workspace:FindFirstChild("__Main")

    if enemiesFolder then
        enemiesFolder = enemiesFolder:FindFirstChild("__Enemies")
        if enemiesFolder then
            enemiesFolder = enemiesFolder:FindFirstChild("Server")
        end
    end

    if enemiesFolder then
        for _, mob in pairs(enemiesFolder:GetChildren()) do
            if not castleInfEnabled then break end

            local hp = mob:GetAttribute("HP")
            if hp and hp > 0 and mob.Position then
                if Player.Character and Player.Character:FindFirstChild("HumanoidRootPart") then
                    -- Teleportar para o mob
                    Player.Character.HumanoidRootPart.CFrame = mob.CFrame * CFrame.new(0, 0, 3)

                    -- Atacar o mob
                    pcall(function()
                        Remote:FireServer({
                            {
                                ["PetPos"] = {},
                                ["AttackType"] = "All", 
                                ["Event"] = "Attack",
                                ["Enemy"] = mob.Name
                            },
                            "\7"
                        })
                    end)

                    -- AGUARDAR O MOB MORRER ANTES DE IR PARA O PRÃ“XIMO
                    while castleInfEnabled and mob.Parent do
                        local currentHP = mob:GetAttribute("HP")
                        if not currentHP or currentHP <= 0 then
                            break
                        end
                        task.wait(0.2)
                    end

                    mobsKilled = true
                end
            end
        end
    end

    return mobsKilled
end

-- =====================================================
-- CASTLE â€” LOOPS
-- =====================================================
local function castleInfLoop()
    task.spawn(function()
        while castleInfEnabled do
            local hasMobs = farmCastleMobs()
            if not hasMobs then
                if teleportToFirePortal() then
                    task.wait(1)
                    activateFirePortal()
                end
            end
            task.wait(0.4)
        end
    end)
end

local function autoCastleLoop()
    task.spawn(function()
        while autoCastleEnabled do
            local currentFloor = getCurrentCastleFloor()
            if not currentFloor then
                buyCastleTicket()
                task.wait(1)
                createCastle()
                task.wait(1)
                joinCastle(entryFloor)
                task.wait(5)
            else
                if currentFloor >= resetFloor then
                    buyCastleTicket()
                    task.wait(1)
                    createCastle()
                    task.wait(1)
                    joinCastle(entryFloor)
                    task.wait(5)
                else
                    farmCastleMobs()
                end
            end
            task.wait(0.5)
        end
    end)
end

local function castleCreateOnlyLoop()
    task.spawn(function()
        while castleCreateOnlyEnabled do
            local currentFloor = getCurrentCastleFloor()
            if not currentFloor then
                buyCastleTicket()
                task.wait(1)
                createCastle()
                task.wait(1)
                joinCastle(entryFloor)
                task.wait(5)
            end
            task.wait(1)
        end
    end)
end

-- =====================================================
-- CASTLE â€” UI
-- =====================================================
Tabs.Castle:AddInput("EntryFloor", {
    Title = "Andar de Entrada",
    Default = tostring(entryFloor),
    Numeric = true,
    Finished = true,
    Callback = function(v)
        local n = tonumber(v)
        if n then
            entryFloor = n
            Config.EntryFloor = n
        end
    end
})

Tabs.Castle:AddInput("ResetFloor", {
    Title = "Andar de Reset",
    Default = tostring(resetFloor),
    Numeric = true,
    Finished = true,
    Callback = function(v)
        local n = tonumber(v)
        if n then
            resetFloor = n
            Config.ResetFloor = n
        end
    end
})

Tabs.Castle:AddToggle("CastleINF", {
    Title = "Castle INF (Farm + Portal)",
    Default = false,
    Callback = function(v)
        castleInfEnabled = v
        Config.CastleInf = v
        if v then castleInfLoop() end
    end
})

Tabs.Castle:AddToggle("AutoCastle", {
    Title = "Auto Castle (Create + Reset)",
    Default = false,
    Callback = function(v)
        autoCastleEnabled = v
        Config.AutoCastle = v
        if v then autoCastleLoop() end
    end
})

Tabs.Castle:AddToggle("CastleCreateOnly", {
    Title = "Auto Castle (Criar Apenas)",
    Default = false,
    Callback = function(v)
        castleCreateOnlyEnabled = v
        Config.CastleCreateOnly = v
        if v then castleCreateOnlyLoop() end
    end
})

Tabs.Castle:AddDropdown("CastleSpeed", {
    Title = "Speed do Castelo",
    Values = {"1", "2", "4"},
    Default = selectedCastleSpeed,
    Callback = function(v)
        selectedCastleSpeed = v
        Config.CastleSpeed = v
        if castleSpeedEnabled then
            SafeFire({
                Event = "CastleAction",
                Action = "SpeedUp",
                Speed = tonumber(v)
            })
        end
    end
})

Tabs.Castle:AddToggle("EnableCastleSpeed", {
    Title = "Ativar Speed do Castelo",
    Default = false,
    Callback = function(v)
        castleSpeedEnabled = v
        Config.CastleSpeedEnabled = v
        if v then
            SafeFire({
                Event = "CastleAction",
                Action = "SpeedUp",
                Speed = tonumber(selectedCastleSpeed)
            })
        end
    end
})

Fluent:Notify({
    Title = "Castle",
    Content = "Parte 3 carregada (Castle completo OK)",
    Duration = 5
})
-- =====================================================
-- ISLANDS â€” DETECÃ‡ÃƒO REAL PELO WORKSPACE
-- =====================================================
local IslandsFolder = workspace:WaitForChild("__Main")
    :WaitForChild("__World")
    :WaitForChild("__Extra")
    :WaitForChild("__Spawns")

local Islands = {}
local IslandNames = {}

local function ScanIslands()
    table.clear(Islands)
    table.clear(IslandNames)

    for _, island in ipairs(IslandsFolder:GetChildren()) do
        if island:IsA("BasePart") or island:IsA("Model") then
            local name = island.Name
            Islands[name] = island
            table.insert(IslandNames, name)
        end
    end
end

ScanIslands()

local function TeleportToIsland(name)
    local island = Islands[name]
    if not island then return end

    local hrp = Player.Character and Player.Character:FindFirstChild("HumanoidRootPart")
    if not hrp then return end

    local cf
    if island:IsA("Model") then
        cf = island:GetPivot()
    else
        cf = island.CFrame
    end

    hrp.CFrame = cf * CFrame.new(0, 6, 0)
    hrp.Velocity = Vector3.zero
end

-- =====================================================
-- ISLANDS â€” UI
-- =====================================================
Tabs.World:AddDropdown("IslandsTP", {
    Title = "Teleportar para Ilha",
    Values = IslandNames,
    Callback = function(v)
        TeleportToIsland(v)
    end
})

Tabs.World:AddButton({
    Title = "Atualizar Ilhas",
    Callback = function()
        ScanIslands()
        Fluent:Notify({
            Title = "Ilhas",
            Content = "Lista de ilhas atualizada",
            Duration = 3
        })
    end
})

-- =====================================================
-- AUTO REBIRTH (SAFE)
-- =====================================================
local rebirthCooldown = 0

RunService.Heartbeat:Connect(function(dt)
    rebirthCooldown += dt

    if not Config.AutoRebirth or rebirthCooldown < 2 then return end
    if Rebirthing or CreatingDungeon then return end

    local leaderstats = Player:FindFirstChild("leaderstats")
    local rebirths = leaderstats and leaderstats:FindFirstChild("Rebirths")
    local gems = leaderstats and leaderstats:FindFirstChild("Gems")

    if rebirths and gems then
        SafeFire({
            Event = "Rebirth"
        })
        rebirthCooldown = 0
    end
end)

Tabs.World:AddToggle("AutoRebirth", {
    Title = "Auto Rebirth",
    Default = false,
    Callback = function(v)
        Config.AutoRebirth = v
    end
})

-- =====================================================
-- FINAL STATUS + CLEANUP
-- =====================================================
Tabs.Misc:AddButton({
    Title = "Resetar Status",
    Callback = function()
        CreatingDungeon = false
        DungeonRunning = false
        Rebirthing = false
        SpawnConfirmTime = 0
        Status:SetDesc("Resetado")
    end
})

Tabs.Misc:AddButton({
    Title = "Reconectar",
    Callback = function()
        game:GetService("TeleportService"):Teleport(game.PlaceId, Player)
    end
})

-- =====================================================
-- SCRIPT FINALIZADO
-- =====================================================
Fluent:Notify({
    Title = "Script Completo",
    Content = "Dungeon + Castle + Ilhas + Rebirth carregados",
    Duration = 6
})

print("âœ… SCRIPT 100% CARREGADO E FUNCIONAL")
